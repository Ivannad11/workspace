<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WorkSpace ‚Äî –†–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
--bg:#111113;--bg2:#1a1a1f;--bg3:#232329;--bg4:#2e2e36;--bg5:#3a3a44;
--accent:#4f8ff7;--accent2:#6ba1ff;--accent-soft:rgba(79,143,247,.12);
--green:#34d399;--red:#f87171;--yellow:#fbbf24;--purple:#a78bfa;--pink:#f472b6;--orange:#fb923c;
--t1:#eaedf3;--t2:#8b8fa4;--t3:#54566b;
--radius:8px;--radius2:12px;--radius3:16px;
--font:'Inter',system-ui,sans-serif;
--sidebar-w:280px;--header-h:52px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--t1);overflow:hidden;height:100vh;-webkit-user-select:auto;user-select:auto}
::selection{background:var(--accent-soft)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
button{font-family:var(--font)}

.header{height:var(--header-h);background:var(--bg2);border-bottom:1px solid var(--bg4);display:flex;align-items:center;padding:0 16px;gap:8px;position:fixed;top:0;left:0;right:0;z-index:200}
.h-toggle{background:none;border:none;color:var(--t3);cursor:pointer;padding:6px;border-radius:6px;display:flex}
.h-toggle:hover{background:var(--bg3);color:var(--t1)}
.h-toggle svg{width:20px;height:20px}
.h-logo{font-weight:800;font-size:16px;color:var(--accent);display:flex;align-items:center;gap:6px}
.h-logo svg{width:22px;height:22px}
.h-sep{width:1px;height:24px;background:var(--bg4);margin:0 4px}
.h-crumb{font-size:13px;color:var(--t3);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.h-crumb b{color:var(--t2);font-weight:600}
.h-actions{display:flex;gap:4px;align-items:center}
.h-btn{background:none;border:none;color:var(--t3);cursor:pointer;padding:6px 10px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:5px;transition:.15s}
.h-btn:hover{background:var(--bg3);color:var(--t1)}
.h-btn svg{width:16px;height:16px}
.h-btn.primary{background:var(--accent);color:#fff}
.h-btn.primary:hover{background:#3b7be0}

.sidebar{position:fixed;top:var(--header-h);left:0;bottom:0;width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--bg4);display:flex;flex-direction:column;z-index:100;transition:transform .25s;overflow:hidden}
.sidebar.closed{transform:translateX(-100%)}
.sb-section{padding:8px;overflow-y:auto;flex:1}
.sb-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);padding:12px 10px 6px}
.nav-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;font-size:14px;color:var(--t2);transition:.1s;user-select:none}
.nav-item:hover{background:var(--bg3);color:var(--t1)}
.nav-item.active{background:var(--accent-soft);color:var(--accent)}
.nav-item svg{width:18px;height:18px;flex-shrink:0}
.nav-item .ni-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-item .ni-badge{font-size:10px;background:var(--bg4);padding:2px 6px;border-radius:10px;color:var(--t3);font-weight:600}
.nav-item .ni-actions{opacity:0;display:flex;gap:2px;transition:.1s}
.nav-item:hover .ni-actions{opacity:1}
.ni-act{background:none;border:none;color:var(--t3);cursor:pointer;padding:2px;border-radius:3px;display:flex}
.ni-act:hover{color:var(--red);background:rgba(248,113,113,.1)}
.ni-act svg{width:14px;height:14px}
.sb-add-btn{margin:4px 8px 8px;padding:7px;border:1.5px dashed var(--bg4);border-radius:var(--radius);background:none;color:var(--t3);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px;transition:.15s;width:calc(100% - 16px)}
.sb-add-btn:hover{border-color:var(--accent);color:var(--accent)}
.sb-add-btn svg{width:14px;height:14px}
.ws-select{margin:8px;padding:8px 10px;background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius);color:var(--t1);font-size:13px;display:flex;align-items:center;gap:8px}
.ws-select .ws-icon{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff}
.ws-select .ws-name{flex:1;font-weight:600}
.ws-select svg{width:14px;height:14px;color:var(--t3)}

.main-wrap{margin-left:var(--sidebar-w);margin-top:var(--header-h);height:calc(100vh - var(--header-h));overflow:hidden;transition:margin .25s}
.main-wrap.full{margin-left:0}
.view{display:none;height:100%;overflow-y:auto}
.view.active{display:block}

/* HOME */
.home{padding:40px;max-width:1100px;margin:0 auto}
.home-greeting{font-size:28px;font-weight:800;margin-bottom:4px}
.home-sub{font-size:15px;color:var(--t2);margin-bottom:32px}
.home-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.home-card{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius2);padding:20px;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.home-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.home-card .hc-icon{font-size:32px;margin-bottom:12px}
.home-card .hc-title{font-size:16px;font-weight:700;margin-bottom:4px}
.home-card .hc-desc{font-size:13px;color:var(--t3);line-height:1.5}
.home-card .hc-badge{position:absolute;top:12px;right:12px;font-size:10px;background:var(--bg4);padding:3px 8px;border-radius:6px;color:var(--t3);font-weight:600;text-transform:uppercase}
.home-card.create{border-style:dashed;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:160px}
.home-card.create:hover{background:var(--accent-soft)}
.home-card.create .hc-icon{color:var(--accent)}

/* NOTES */
.notes-area{max-width:820px;margin:0 auto;padding:48px 40px 120px}
.n-icon-btn{font-size:48px;background:none;border:none;cursor:pointer;padding:4px;border-radius:8px;line-height:1;margin-bottom:8px}
.n-icon-btn:hover{background:var(--bg3)}
.n-title{font-size:clamp(30px,5vw,42px);font-weight:800;line-height:1.15;outline:none;margin-bottom:8px}
.n-title:empty::before{content:attr(data-ph);color:var(--t3)}
.block-list{min-height:200px}
.block{position:relative;padding:3px 0;border-radius:4px;transition:background .1s}
.block:hover .blk-side{opacity:1}
.blk-side{position:absolute;left:-48px;top:2px;display:flex;align-items:center;gap:2px;opacity:0;transition:.15s}
.blk-handle{cursor:grab;color:var(--t3);padding:3px;border-radius:4px;display:flex}
.blk-handle:hover{background:var(--bg3);color:var(--t1)}
.blk-handle svg,.blk-plus svg{width:14px;height:14px}
.blk-plus{background:none;border:none;cursor:pointer;color:var(--t3);padding:3px;border-radius:4px;display:flex}
.blk-plus:hover{background:var(--bg3);color:var(--t1)}
[contenteditable]{outline:none}
[contenteditable]:empty::before{content:attr(data-ph);color:var(--t3);pointer-events:none}
.ce-p{font-size:16px;line-height:1.75;color:var(--t2);padding:3px 2px}
.ce-h1{font-size:clamp(24px,3.5vw,32px);font-weight:800;line-height:1.2;padding:12px 2px 4px}
.ce-h2{font-size:clamp(20px,3vw,26px);font-weight:700;line-height:1.25;padding:8px 2px 3px}
.ce-h3{font-size:18px;font-weight:600;line-height:1.3;padding:6px 2px 2px}
.ce-quote{font-size:16px;line-height:1.7;color:var(--t2);border-left:3px solid var(--accent);padding:8px 16px;margin:4px 0}
.ce-bullet{font-size:16px;line-height:1.7;color:var(--t2);padding:2px 2px 2px 24px;position:relative}
.ce-bullet::before{content:'‚Ä¢';position:absolute;left:8px;color:var(--t3)}
.ce-num{font-size:16px;line-height:1.7;color:var(--t2);padding:2px 2px 2px 28px;position:relative}
.ce-num::before{content:attr(data-n)'.';position:absolute;left:4px;color:var(--t3);font-weight:600}
.ce-todo-wrap{display:flex;align-items:flex-start;gap:8px;padding:2px 0}
.ce-todo-cb{width:18px;height:18px;border:2px solid var(--bg5);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:4px;transition:.15s;background:none}
.ce-todo-cb:hover{border-color:var(--accent)}
.ce-todo-cb.checked{background:var(--accent);border-color:var(--accent)}
.ce-todo-cb.checked svg{display:block}
.ce-todo-cb svg{width:12px;height:12px;stroke:#fff;stroke-width:3;fill:none;display:none}
.ce-todo-text{font-size:16px;line-height:1.7;color:var(--t2);flex:1;outline:none}
.ce-todo-text.done{text-decoration:line-through;color:var(--t3)}
.ce-callout{display:flex;gap:10px;padding:16px;background:var(--bg3);border-radius:var(--radius2);margin:4px 0}
.ce-callout-icon{font-size:20px;cursor:pointer;flex-shrink:0}
.ce-callout-body{flex:1;font-size:15px;line-height:1.6;color:var(--t2);outline:none}
.ce-callout-body:empty::before{content:'–¢–µ–∫—Å—Ç...';color:var(--t3);pointer-events:none}
.ce-divider{border:none;border-top:1px solid var(--bg4);margin:14px 0}
.ce-code{font-family:'SF Mono','Fira Code',monospace;font-size:14px;line-height:1.6;background:var(--bg3);padding:16px;border-radius:var(--radius);color:var(--t2);white-space:pre-wrap;tab-size:2}
.ce-img-wrap{width:100%;border-radius:var(--radius);overflow:hidden;margin:6px 0;background:var(--bg3);min-height:100px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px dashed var(--bg4);transition:.15s}
.ce-img-wrap:hover{border-color:var(--accent)}
.ce-img-wrap img{width:100%;display:block}
.ce-img-ph{color:var(--t3);font-size:13px;display:flex;flex-direction:column;align-items:center;gap:6px;padding:28px}
.ce-img-ph svg{width:28px;height:28px}
.ce-img-wrap input[type=file]{display:none}

/* SLIDES */
.slides-area{padding:32px 24px 100px;display:flex;flex-direction:column;align-items:center;gap:28px}
.slide-card{width:100%;max-width:980px;aspect-ratio:16/9;background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius2);overflow:hidden;display:flex;flex-direction:column;transition:.2s}
.slide-card:hover{box-shadow:0 0 0 2px var(--accent)}
.slide-toolbar{display:flex;align-items:center;gap:4px;padding:6px 10px;background:var(--bg3);border-bottom:1px solid var(--bg4);flex-shrink:0;font-size:12px;color:var(--t3)}
.slide-toolbar .st-num{font-weight:700;color:var(--t2);margin-right:4px}
.st-btn{background:none;border:none;color:var(--t3);cursor:pointer;padding:3px 6px;border-radius:4px;display:flex;align-items:center;gap:3px;font-size:11px;font-family:var(--font);transition:.1s}
.st-btn:hover{background:var(--bg4);color:var(--t1)}
.st-btn svg{width:14px;height:14px}
.st-sep{width:1px;height:16px;background:var(--bg4);margin:0 2px}
.layout-btns,.bg-dots{display:flex;gap:3px;align-items:center}
.l-btn{width:26px;height:18px;border:1px solid var(--bg5);border-radius:3px;background:var(--bg4);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.1s}
.l-btn:hover,.l-btn.active{border-color:var(--accent);background:var(--accent-soft)}
.l-btn svg{width:100%;height:100%;stroke:var(--t3);fill:none;stroke-width:1.5}
.l-btn.active svg{stroke:var(--accent)}
.bg-dot{width:16px;height:16px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:.1s}
.bg-dot:hover{transform:scale(1.15)}
.bg-dot.active{border-color:var(--t1)}
.slide-body{flex:1;padding:28px 36px;display:flex;flex-direction:column;overflow:hidden}
.slide-body[data-bg=dark]{background:#111113}
.slide-body[data-bg=navy]{background:linear-gradient(135deg,#0d1829,#162544)}
.slide-body[data-bg=purple]{background:linear-gradient(135deg,#1a1029,#2d1f4e)}
.slide-body[data-bg=accent]{background:var(--accent)}
.slide-body[data-bg=light]{background:#f0f0f5}
.slide-body[data-bg=light] .sl-t,.slide-body[data-bg=light] .sl-s,.slide-body[data-bg=light] .sl-b{color:#222}
.slide-body[data-bg=light] .sl-s{color:#555}
.slide-body.ly-center{justify-content:center;align-items:center;text-align:center}
.slide-body.ly-left{justify-content:center}
.slide-body.ly-split{flex-direction:row;gap:28px}
.slide-body.ly-split .sl-left-col{flex:1;display:flex;flex-direction:column;justify-content:center}
.slide-body.ly-split .sl-right-col{flex:1;display:flex;align-items:center;justify-content:center}
.slide-body.ly-split .sl-img-zone{width:100%;height:100%;background:var(--bg3);border-radius:var(--radius);border:2px dashed var(--bg4);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;transition:.15s}
.slide-body.ly-split .sl-img-zone:hover{border-color:var(--accent)}
.slide-body.ly-split .sl-img-zone img{width:100%;height:100%;object-fit:cover}
.slide-body.ly-content{justify-content:flex-start}
.sl-t{font-size:clamp(24px,3.5vw,44px);font-weight:900;line-height:1.1;outline:none;margin-bottom:8px}
.sl-t:empty::before{content:'–ó–∞–≥–æ–ª–æ–≤–æ–∫';color:var(--t3);pointer-events:none}
.sl-s{font-size:clamp(14px,2vw,20px);color:var(--t2);outline:none;line-height:1.5}
.sl-s:empty::before{content:'–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫';color:var(--t3);pointer-events:none}
.sl-b{font-size:clamp(13px,1.4vw,17px);color:var(--t2);outline:none;flex:1;margin-top:12px;line-height:1.7}
.sl-b:empty::before{content:'–¢–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞';color:var(--t3);pointer-events:none}
.sl-kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:auto;padding-top:12px}
.sl-kpi{background:rgba(255,255,255,.04);border:1px solid var(--bg4);border-radius:var(--radius);padding:14px;text-align:center}
.sl-kpi-v{font-size:26px;font-weight:900;color:var(--green);outline:none}
.sl-kpi-v:empty::before{content:'0';color:var(--t3);pointer-events:none}
.sl-kpi-l{font-size:11px;color:var(--t3);margin-top:3px;outline:none}
.sl-kpi-l:empty::before{content:'–ú–µ—Ç—Ä–∏–∫–∞';color:var(--bg5);pointer-events:none}

/* SHEETS */
.sheets-area{padding:24px;height:100%;display:flex;flex-direction:column}
.sheet-header{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.sheet-header h2{font-size:20px;font-weight:700;flex:1}
.sheet-url-input{flex:2;min-width:240px;background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius);padding:8px 12px;color:var(--t1);font-size:13px;font-family:var(--font);outline:none}
.sheet-url-input:focus{border-color:var(--accent)}
.sheet-url-input::placeholder{color:var(--t3)}
.sheet-frame{flex:1;border:1px solid var(--bg4);border-radius:var(--radius2);overflow:hidden;background:var(--bg2);min-height:300px}
.sheet-frame iframe{width:100%;height:100%;border:none}
.sheet-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px;color:var(--t3);font-size:14px}
.sheet-empty svg{width:48px;height:48px;color:var(--bg5)}
.sheet-tabs{display:flex;gap:4px;margin-bottom:8px;overflow-x:auto;padding-bottom:4px}
.sheet-tab{padding:6px 14px;border-radius:var(--radius) var(--radius) 0 0;background:var(--bg3);border:1px solid var(--bg4);border-bottom:none;cursor:pointer;font-size:13px;color:var(--t2);white-space:nowrap;transition:.1s;display:flex;align-items:center;gap:6px}
.sheet-tab:hover{background:var(--bg4);color:var(--t1)}
.sheet-tab.active{background:var(--bg2);color:var(--accent);border-color:var(--accent) var(--accent) transparent}
.sheet-tab .st-del{display:none;background:none;border:none;color:var(--t3);cursor:pointer;padding:0 2px;font-size:14px}
.sheet-tab:hover .st-del{display:block}
.sheet-tab .st-del:hover{color:var(--red)}
.add-sheet-tab{padding:6px 10px;border:1.5px dashed var(--bg4);border-radius:var(--radius) var(--radius) 0 0;background:none;color:var(--t3);cursor:pointer;font-size:16px;transition:.1s}
.add-sheet-tab:hover{border-color:var(--accent);color:var(--accent)}

/* KANBAN */
.kanban-area{padding:24px;height:100%;display:flex;flex-direction:column}
.kanban-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.kanban-header h2{font-size:20px;font-weight:700;flex:1}
.kanban-board{display:flex;gap:16px;flex:1;overflow-x:auto;padding-bottom:16px}
.kanban-col{min-width:280px;max-width:320px;background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius2);display:flex;flex-direction:column;flex-shrink:0}
.kanban-col-head{padding:12px 14px;border-bottom:1px solid var(--bg4);display:flex;align-items:center;gap:8px}
.kc-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.kc-title{font-size:14px;font-weight:600;flex:1;outline:none}
.kc-count{font-size:11px;color:var(--t3);background:var(--bg4);padding:2px 6px;border-radius:8px}
.kc-del{background:none;border:none;color:var(--t3);cursor:pointer;padding:2px;border-radius:3px;display:flex;opacity:0;transition:.1s}
.kanban-col-head:hover .kc-del{opacity:1}
.kc-del:hover{color:var(--red);background:rgba(248,113,113,.1)}
.kc-del svg{width:14px;height:14px}
.kanban-cards{flex:1;padding:8px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;min-height:60px;transition:background .15s}
.kanban-cards.drag-hover{background:var(--accent-soft);border-radius:var(--radius)}
.kanban-card{background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius);padding:10px 12px;cursor:grab;transition:.15s;font-size:14px;position:relative}
.kanban-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.kanban-card.dragging{opacity:.5;transform:scale(.96)}
.kanban-card.drag-over-top{border-top:2px solid var(--accent)}
.kanban-card.drag-over-bot{border-bottom:2px solid var(--accent)}
.kk-title-text{font-weight:500;color:var(--t1)}
.kk-desc{font-size:12px;color:var(--t3);margin-top:4px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.kk-meta{display:flex;align-items:center;gap:6px;margin-top:8px;flex-wrap:wrap}
.kk-priority{font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.kk-priority.p-high{background:rgba(248,113,113,.15);color:var(--red)}
.kk-priority.p-mid{background:rgba(251,191,36,.15);color:var(--yellow)}
.kk-priority.p-low{background:rgba(52,211,153,.15);color:var(--green)}
.kk-date{font-size:11px;color:var(--t3);display:flex;align-items:center;gap:3px}
.kk-date svg{width:12px;height:12px}
.kk-date.overdue{color:var(--red)}
.kk-edit{position:absolute;top:6px;right:6px;opacity:0;background:var(--bg4);border:none;color:var(--t2);cursor:pointer;width:22px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:.1s}
.kanban-card:hover .kk-edit{opacity:1}
.kk-edit:hover{background:var(--accent);color:#fff}
.kk-edit svg{width:12px;height:12px}

.knf{background:var(--bg3);border:1px solid var(--accent);border-radius:var(--radius);padding:10px;margin:4px 8px 8px;display:none}
.knf.open{display:block}
.knf-input{width:100%;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:7px 10px;color:var(--t1);font-size:13px;font-family:var(--font);outline:none;margin-bottom:6px;resize:none}
.knf-input:focus{border-color:var(--accent)}
.knf-input::placeholder{color:var(--t3)}
.knf-row{display:flex;gap:6px;margin-bottom:8px}
.knf-sel{background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:5px 8px;color:var(--t2);font-size:12px;font-family:var(--font);outline:none}
.knf-date{background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:5px 8px;color:var(--t2);font-size:12px;font-family:var(--font);outline:none}
.knf-actions{display:flex;gap:6px}
.knf-btn{padding:6px 14px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font)}
.knf-btn.ok{background:var(--accent);color:#fff}
.knf-btn.ok:hover{background:#3b7be0}
.knf-btn.cancel{background:var(--bg4);color:var(--t2)}

.kanban-add{padding:6px;border:none;background:none;color:var(--t3);cursor:pointer;font-size:13px;display:flex;align-items:center;gap:4px;border-radius:var(--radius);margin:4px 8px 8px;transition:.1s}
.kanban-add:hover{background:var(--bg3);color:var(--t1)}
.kanban-add svg{width:14px;height:14px}
.add-col-btn{min-width:280px;border:2px dashed var(--bg4);border-radius:var(--radius2);background:none;color:var(--t3);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;gap:6px;transition:.15s;flex-shrink:0}
.add-col-btn:hover{border-color:var(--accent);color:var(--accent)}

/* SLASH */
.slash-menu{position:absolute;z-index:3000;background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius2);box-shadow:0 8px 32px rgba(0,0,0,.5);padding:6px;width:260px;max-height:340px;overflow-y:auto;display:none}
.slash-menu.vis{display:block}
.sm-input{width:100%;background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius);padding:7px 10px;color:var(--t1);font-size:13px;font-family:var(--font);outline:none;margin-bottom:4px}
.sm-grp{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);padding:8px 8px 4px;font-weight:700}
.sm-it{display:flex;align-items:center;gap:10px;padding:5px 8px;border-radius:var(--radius);cursor:pointer;transition:.1s}
.sm-it:hover{background:var(--bg3)}
.sm-it-icon{width:34px;height:34px;border-radius:8px;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.sm-it-name{font-size:14px;color:var(--t1)}
.sm-it-desc{font-size:11px;color:var(--t3)}
.inline-tb{position:absolute;z-index:5000;background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);box-shadow:0 4px 16px rgba(0,0,0,.4);padding:3px;display:none;gap:1px}
.inline-tb.vis{display:flex}
.itb{background:none;border:none;color:var(--t2);cursor:pointer;padding:5px 7px;border-radius:4px;font-size:14px;font-weight:600;transition:.1s}
.itb:hover{background:var(--bg3);color:var(--t1)}
.itb.active{color:var(--accent)}

/* PRESENT */
.present-ov{position:fixed;inset:0;z-index:10000;background:#000;display:none;align-items:center;justify-content:center}
.present-ov.vis{display:flex}
.pres-slide{width:100%;height:100%;display:flex;flex-direction:column}
.pres-controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:12px;align-items:center;background:rgba(26,26,31,.9);border:1px solid var(--bg4);border-radius:40px;padding:8px 20px;backdrop-filter:blur(8px);opacity:0;transition:.3s}
.present-ov:hover .pres-controls{opacity:1}
.pres-controls button{background:none;border:none;color:var(--t2);cursor:pointer;font-size:18px;padding:4px 8px;border-radius:6px}
.pres-controls button:hover{background:var(--bg3);color:var(--t1)}
.pres-controls .pn{font-size:13px;color:var(--t3);min-width:50px;text-align:center}

/* MODALS */
.modal-bg,.task-modal-bg{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-bg.vis,.task-modal-bg.vis{display:flex}
.task-modal-bg{z-index:9000;align-items:flex-start;padding-top:10vh}
.modal,.task-modal{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius3);padding:28px;width:90%;max-width:480px;box-shadow:0 16px 48px rgba(0,0,0,.5)}
.task-modal{max-width:540px;padding:0;overflow:hidden}
.modal h3{font-size:18px;font-weight:700;margin-bottom:16px}
.modal-input,.tm-input{width:100%;background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius);padding:10px 12px;color:var(--t1);font-size:14px;font-family:var(--font);outline:none;margin-bottom:12px}
.modal-input:focus,.tm-input:focus{border-color:var(--accent)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}
.modal-btn{padding:8px 18px;border-radius:var(--radius);border:none;cursor:pointer;font-size:14px;font-family:var(--font);transition:.15s}
.modal-btn.cancel{background:var(--bg3);color:var(--t2)}
.modal-btn.cancel:hover{background:var(--bg4)}
.modal-btn.ok{background:var(--accent);color:#fff}
.modal-btn.ok:hover{background:#3b7be0}
.modal-types{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.modal-type{padding:16px;border:1px solid var(--bg4);border-radius:var(--radius);cursor:pointer;text-align:center;transition:.15s}
.modal-type:hover,.modal-type.selected{border-color:var(--accent);background:var(--accent-soft)}
.modal-type .mt-icon{font-size:24px;margin-bottom:6px}
.modal-type .mt-name{font-size:13px;font-weight:600}

.tm-header{display:flex;align-items:center;gap:8px;padding:16px 20px;border-bottom:1px solid var(--bg4)}
.tm-header span:first-child{font-weight:700}
.tm-col-badge{font-size:11px;background:var(--bg4);padding:3px 8px;border-radius:6px;color:var(--t3)}
.tm-close{margin-left:auto;background:none;border:none;color:var(--t3);cursor:pointer;font-size:18px;padding:4px;border-radius:4px}
.tm-close:hover{background:var(--bg3);color:var(--t1)}
.tm-body{padding:20px}
.tm-field{margin-bottom:16px}
.tm-field label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:6px}
.tm-textarea{width:100%;background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius);padding:9px 12px;color:var(--t1);font-size:14px;font-family:var(--font);outline:none;min-height:80px;resize:vertical}
.tm-textarea:focus{border-color:var(--accent)}
.tm-row{display:flex;gap:12px}
.tm-row .tm-field{flex:1}
.tm-footer{display:flex;gap:8px;justify-content:space-between;padding:0 20px 20px}
.tm-del{background:none;border:1px solid var(--red);color:var(--red);padding:8px 16px;border-radius:var(--radius);cursor:pointer;font-size:13px;font-family:var(--font)}
.tm-del:hover{background:rgba(248,113,113,.1)}
.tm-save{background:var(--accent);color:#fff;border:none;padding:8px 20px;border-radius:var(--radius);cursor:pointer;font-size:13px;font-family:var(--font)}
.tm-save:hover{background:#3b7be0}

@media(max-width:768px){
.sidebar{width:100%;transform:translateX(-100%)}
.sidebar.open-m{transform:translateX(0)}
.main-wrap{margin-left:0!important}
.notes-area{padding:24px 16px 80px}
.blk-side{left:-34px}
.slide-card{aspect-ratio:auto;min-height:50vh}
.slide-body.ly-split{flex-direction:column}
.kanban-col{min-width:260px}
.home{padding:24px 16px}
}
@media print{
.header,.sidebar,.blk-side,.slash-menu,.inline-tb,.slide-toolbar,.pres-controls,.modal-bg,.task-modal-bg{display:none!important}
.main-wrap{margin-left:0!important;margin-top:0!important;height:auto!important}
body{overflow:visible;background:#fff;color:#111}
.slide-card{break-after:page;border:none!important;border-radius:0!important;aspect-ratio:auto;min-height:100vh}
}

.notes-area [contenteditable]{cursor:text;-webkit-user-select:text;user-select:text}
.n-title{cursor:text;-webkit-user-select:text;user-select:text}
.block-list [contenteditable]:focus{position:relative;z-index:1}

</style>
</head>
<body>

<div class="header">
<button class="h-toggle" id="hToggle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
<div class="h-logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M9 3v18M15 8h-2M15 12h-2M15 16h-2"/></svg> WorkSpace</div>
<div class="h-sep"></div>
<div class="h-crumb" id="crumb"><b>–ì–ª–∞–≤–Ω–∞—è</b></div>
<div class="h-actions">
<button class="h-btn" id="hPresent" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21"/></svg> –ü–æ–∫–∞–∑</button>
<button class="h-btn" id="hExport"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> PDF</button>
</div>
</div>

<div class="sidebar" id="sidebar">
<div class="ws-select"><div class="ws-icon">W</div><div class="ws-name">Workspace</div><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
<div style="padding:4px 8px"><div class="nav-item active" id="navHome"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg><span class="ni-label">–ì–ª–∞–≤–Ω–∞—è</span></div></div>
<div class="sb-section" id="sbProjects"><div class="sb-label">–ü—Ä–æ–µ–∫—Ç—ã</div><div id="projectNav"></div><button class="sb-add-btn" id="newProjectBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button></div>
</div>

<div class="main-wrap" id="mainWrap">
<div class="view active" id="viewHome"></div>
<div class="view" id="viewNotes"></div>
<div class="view" id="viewSlides"></div>
<div class="view" id="viewSheets"></div>
<div class="view" id="viewKanban"></div>
</div>

<div class="slash-menu" id="slashMenu"><input class="sm-input" id="smInput" placeholder="–ü–æ–∏—Å–∫..." autocomplete="off"><div id="smItems"></div></div>
<div class="inline-tb" id="inlineTb"><button class="itb" data-c="bold"><b>B</b></button><button class="itb" data-c="italic"><i>I</i></button><button class="itb" data-c="underline"><u>U</u></button><button class="itb" data-c="strikeThrough"><s>S</s></button><button class="itb" data-c="createLink">üîó</button></div>
<div class="present-ov" id="presOv"><div class="pres-slide" id="presSlide"></div><div class="pres-controls"><button id="presPrev">‚óÄ</button><span class="pn" id="presNum">1/1</span><button id="presNext">‚ñ∂</button><button id="presClose">‚úï</button></div></div>

<div class="modal-bg" id="modalBg"><div class="modal"><h3>–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3><div class="modal-types" id="modalTypes"><div class="modal-type selected" data-type="notes"><div class="mt-icon">üìù</div><div class="mt-name">–ó–∞–º–µ—Ç–∫–∏</div></div><div class="modal-type" data-type="slides"><div class="mt-icon">üñ•</div><div class="mt-name">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è</div></div><div class="modal-type" data-type="sheets"><div class="mt-icon">üìä</div><div class="mt-name">–¢–∞–±–ª–∏—Ü—ã</div></div><div class="modal-type" data-type="kanban"><div class="mt-icon">üìã</div><div class="mt-name">–ö–∞–Ω–±–∞–Ω</div></div></div><input class="modal-input" id="modalInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"><div class="modal-actions"><button class="modal-btn cancel" id="modalCancel">–û—Ç–º–µ–Ω–∞</button><button class="modal-btn ok" id="modalOk">–°–æ–∑–¥–∞—Ç—å</button></div></div></div>

<div class="task-modal-bg" id="taskModalBg"><div class="task-modal"><div class="tm-header"><span>–ó–∞–¥–∞—á–∞</span><span class="tm-col-badge" id="tmColBadge"></span><button class="tm-close" id="tmClose">‚úï</button></div><div class="tm-body"><div class="tm-field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="tm-input" id="tmTitle" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"></div><div class="tm-field"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea class="tm-textarea" id="tmDesc" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏..."></textarea></div><div class="tm-row"><div class="tm-field"><label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label><select class="tm-input" id="tmPriority" style="cursor:pointer"><option value="">‚Äî</option><option value="high">–í—ã—Å–æ–∫–∏–π</option><option value="mid">–°—Ä–µ–¥–Ω–∏–π</option><option value="low">–ù–∏–∑–∫–∏–π</option></select></div><div class="tm-field"><label>–î–µ–¥–ª–∞–π–Ω</label><input class="tm-input" id="tmDate" type="date"></div></div><div class="tm-field"><label>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤</label><select class="tm-input" id="tmMove" style="cursor:pointer"></select></div></div><div class="tm-footer"><button class="tm-del" id="tmDel">–£–¥–∞–ª–∏—Ç—å</button><button class="tm-save" id="tmSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div></div>

<script>
const K='workspace_v5';
const uid=()=>Math.random().toString(36).substr(2,9)+Date.now().toString(36);
const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};

let S={projects:[],current:null};
let dragCard=null,dragFromCol=null,editCard=null,editCol=null;

function load(){try{const d=JSON.parse(localStorage.getItem(K));if(d?.projects)S=d;else throw 0}catch{S={projects:[],current:null}}}
function save(){syncFromDom();localStorage.setItem(K,JSON.stringify(S))}
function proj(id){return S.projects.find(p=>p.id===(id||S.current))}
function syncFromDom(){const p=proj();if(!p)return;if(p.type==='notes')readNotes(p);else if(p.type==='slides')readSlides(p);else if(p.type==='sheets')readSheets(p)}
function defaultSlide(){return{id:uid(),layout:'left',bg:'dark',title:'',subtitle:'',body:'',kpis:[],imgSrc:''}}

function createProject(type,name){
const p={id:uid(),type,name:name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',icon:{'notes':'üìù','slides':'üñ•','sheets':'üìä','kanban':'üìã'}[type],created:Date.now()};
if(type==='notes')p.blocks=[{id:uid(),type:'p',content:''}];
else if(type==='slides')p.slides=[defaultSlide()];
else if(type==='sheets')p.sheets=[{id:uid(),name:'–õ–∏—Å—Ç 1',url:''}];
else if(type==='kanban')p.columns=[{id:uid(),title:'–°–¥–µ–ª–∞—Ç—å',color:'#54566b',cards:[]},{id:uid(),title:'–í —Ä–∞–±–æ—Ç–µ',color:'#4f8ff7',cards:[]},{id:uid(),title:'–ì–æ—Ç–æ–≤–æ',color:'#34d399',cards:[]}];
S.projects.push(p);S.current=p.id;save();renderSidebar();openProject(p.id);
}
function deleteProject(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?'))return;S.projects=S.projects.filter(p=>p.id!==id);if(S.current===id)S.current=null;save();renderSidebar();showHome()}

function renderSidebar(){
const c=$('#projectNav');c.innerHTML='';
S.projects.forEach(p=>{const d=document.createElement('div');d.className='nav-item'+(S.current===p.id?' active':'');
d.innerHTML=`<span style="font-size:16px">${p.icon||'üìÑ'}</span><span class="ni-label">${esc(p.name)}</span><span class="ni-badge">${p.type}</span><span class="ni-actions"><button class="ni-act" title="–£–¥–∞–ª–∏—Ç—å"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></span>`;
d.querySelector('.ni-act').onclick=e=>{e.stopPropagation();deleteProject(p.id)};d.onclick=()=>openProject(p.id);c.appendChild(d)})
}
function showView(id){$$('.view').forEach(v=>v.classList.remove('active'));$(id).classList.add('active')}
function showHome(){S.current=null;$$('.nav-item').forEach(n=>n.classList.remove('active'));$('#navHome').classList.add('active');$('#crumb').innerHTML='<b>–ì–ª–∞–≤–Ω–∞—è</b>';$('#hPresent').style.display='none';showView('#viewHome');renderHome();save()}
function openProject(id){S.current=id;renderSidebar();const p=proj();if(!p)return showHome();
$('#crumb').innerHTML=`<b>${esc(p.name)}</b> <span style="color:var(--t3)">¬∑ ${p.type}</span>`;
$('#hPresent').style.display=p.type==='slides'?'flex':'none';
if(p.type==='notes'){showView('#viewNotes');renderNotes(p)}
else if(p.type==='slides'){showView('#viewSlides');renderSlidesView(p)}
else if(p.type==='sheets'){showView('#viewSheets');renderSheetsView(p)}
else if(p.type==='kanban'){showView('#viewKanban');renderKanban(p)}
if(innerWidth<=768){$('#sidebar').classList.remove('open-m')}
}

function renderHome(){
const v=$('#viewHome');
const cards=S.projects.map(p=>`<div class="home-card" data-pid="${p.id}"><div class="hc-icon">${p.icon}</div><div class="hc-title">${esc(p.name)}</div><div class="hc-desc">${{'notes':'–î–æ–∫—É–º–µ–Ω—Ç','slides':'–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è','sheets':'Google –¢–∞–±–ª–∏—Ü—ã','kanban':'–î–æ—Å–∫–∞ –∑–∞–¥–∞—á'}[p.type]}</div><div class="hc-badge">${p.type}</div></div>`).join('');
v.innerHTML=`<div class="home"><div class="home-greeting">–†–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</div><div class="home-sub">–ó–∞–º–µ—Ç–∫–∏, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏, —Ç–∞–±–ª–∏—Ü—ã –∏ –∑–∞–¥–∞—á–∏ ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ</div><div class="home-grid">${cards}<div class="home-card create" id="homeCreate"><div class="hc-icon">+</div><div class="hc-title">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div></div></div></div>`;
v.querySelectorAll('[data-pid]').forEach(c=>c.onclick=()=>openProject(c.dataset.pid));
$('#homeCreate').onclick=()=>openModal();
}

/* ‚ïê‚ïê‚ïê NOTES ‚ïê‚ïê‚ïê */
const BT=[{g:'–û—Å–Ω–æ–≤–Ω—ã–µ',items:[{t:'p',n:'–¢–µ–∫—Å—Ç',d:'–ê–±–∑–∞—Ü',i:'Aa'},{t:'h1',n:'–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1',d:'–ö—Ä—É–ø–Ω—ã–π',i:'H1'},{t:'h2',n:'–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2',d:'–°—Ä–µ–¥–Ω–∏–π',i:'H2'},{t:'h3',n:'–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3',d:'–ú–∞–ª—ã–π',i:'H3'}]},{g:'–°–ø–∏—Å–∫–∏',items:[{t:'bullet',n:'–ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π',d:'–¢–æ—á–∫–∏',i:'‚Ä¢'},{t:'num',n:'–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π',d:'–ß–∏—Å–ª–∞',i:'1.'},{t:'todo',n:'–ß–µ–∫-–ª–∏—Å—Ç',d:'–ó–∞–¥–∞—á–∏',i:'‚òë'}]},{g:'–ú–µ–¥–∏–∞',items:[{t:'quote',n:'–¶–∏—Ç–∞—Ç–∞',d:'–í—ã–¥–µ–ª–µ–Ω–Ω–∞—è',i:'‚ùù'},{t:'callout',n:'–í—ã–Ω–æ—Å–∫–∞',d:'–ë–ª–æ–∫',i:'üí°'},{t:'code',n:'–ö–æ–¥',d:'–ú–æ–Ω–æ',i:'<>'},{t:'divider',n:'–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å',d:'–õ–∏–Ω–∏—è',i:'‚Äî'},{t:'image',n:'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',d:'–§–æ—Ç–æ',i:'üñº'}]}];

function renderNotes(p){
const v=$('#viewNotes');
v.innerHTML=`<div class="notes-area"><button class="n-icon-btn" id="nIcon">${p.icon||'üìù'}</button><div class="n-title" contenteditable="true" data-ph="–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" id="nTitle">${esc(p.name)}</div><div class="block-list" id="blockList"></div></div>`;
const bl=$('#blockList');(p.blocks||[]).forEach(b=>bl.appendChild(mkBlock(b)));renum();
$('#nTitle').addEventListener('input',()=>{p.name=$('#nTitle').textContent;save();renderSidebar()});
$('#nTitle').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();const f=$('#blockList .block');if(f){const c=f.querySelector('[contenteditable]');if(c)c.focus()}}});
}
function readNotes(p){const t=$('#nTitle');if(t)p.name=t.textContent;p.blocks=[];$$('#blockList .block').forEach(el=>{const o={id:el.dataset.id,type:el.dataset.type};if(o.type==='divider'){p.blocks.push(o);return}if(o.type==='callout'){o.icon=el.querySelector('.ce-callout-icon')?.textContent||'üí°';o.content=el.querySelector('.ce-callout-body')?.innerHTML||'';p.blocks.push(o);return}if(o.type==='image'){const img=el.querySelector('img');o.src=img?img.src:'';p.blocks.push(o);return}if(o.type==='todo'){o.checked=!!el.querySelector('.ce-todo-cb.checked');o.content=el.querySelector('.ce-todo-text')?.innerHTML||'';p.blocks.push(o);return}const ce=el.querySelector('[contenteditable]');o.content=ce?ce.innerHTML:'';p.blocks.push(o)})}

function mkBlock(b){
const w=document.createElement('div');w.className='block';w.dataset.id=b.id;w.dataset.type=b.type;w.draggable=true;
const side=document.createElement('div');side.className='blk-side';
side.innerHTML=`<button class="blk-plus"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg></button><span class="blk-handle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>`;
side.querySelector('.blk-plus').onclick=()=>slashOpen(w);w.appendChild(side);
const C=document.createElement('div');C.style.cssText='flex:1;min-width:0';
if(b.type==='divider')C.innerHTML='<hr class="ce-divider">';
else if(b.type==='callout')C.innerHTML=`<div class="ce-callout"><span class="ce-callout-icon">${b.icon||'üí°'}</span><div class="ce-callout-body" contenteditable="true">${b.content||''}</div></div>`;
else if(b.type==='image'){C.innerHTML=`<div class="ce-img-wrap">${b.src?`<img src="${b.src}">`:'<div class="ce-img-ph"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>–ó–∞–≥—Ä—É–∑–∏—Ç—å</div>'}<input type="file" accept="image/*"></div>`;setTimeout(()=>{const wr=C.querySelector('.ce-img-wrap'),inp=C.querySelector('input[type=file]');wr?.addEventListener('click',()=>inp.click());inp?.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{wr.innerHTML=`<img src="${ev.target.result}"><input type="file" accept="image/*">`;save()};r.readAsDataURL(f)})},0)}
else if(b.type==='todo'){const ch=b.checked?'checked':'',dn=b.checked?'done':'';C.innerHTML=`<div class="ce-todo-wrap"><div class="ce-todo-cb ${ch}"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="ce-todo-text ${dn}" contenteditable="true" data-ph="–ó–∞–¥–∞—á–∞...">${b.content||''}</div></div>`;setTimeout(()=>{C.querySelector('.ce-todo-cb')?.addEventListener('click',()=>{C.querySelector('.ce-todo-cb').classList.toggle('checked');C.querySelector('.ce-todo-text').classList.toggle('done');save()})},0)}
else{const cls={'p':'ce-p','h1':'ce-h1','h2':'ce-h2','h3':'ce-h3','quote':'ce-quote','bullet':'ce-bullet','num':'ce-num','code':'ce-code'}[b.type]||'ce-p';const ph={'p':'–¢–µ–∫—Å—Ç –∏–ª–∏ / –¥–ª—è –∫–æ–º–∞–Ω–¥','h1':'–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1','h2':'–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2','h3':'–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3','quote':'–¶–∏—Ç–∞—Ç–∞','bullet':'–ü—É–Ω–∫—Ç','num':'–ü—É–Ω–∫—Ç','code':'–ö–æ–¥'}[b.type]||'';C.innerHTML=`<div class="${cls}" contenteditable="true" data-ph="${ph}">${b.content||''}</div>`}
w.appendChild(C);
const ce=w.querySelector('[contenteditable]');if(ce){ce.addEventListener('keydown',e=>blkKey(e,w));ce.addEventListener('input',()=>{save();renum()})}
w.addEventListener('dragstart',e=>{w.style.opacity='.4';w._drag=true;e.dataTransfer.effectAllowed='move'});
w.addEventListener('dragend',()=>{w.style.opacity='1';w._drag=false;$$('.block').forEach(b=>b.style.borderTop='')});
w.addEventListener('dragover',e=>{e.preventDefault();const src=$$('.block').find(b=>b._drag);if(src&&src!==w)w.style.borderTop='2px solid var(--accent)'});
w.addEventListener('dragleave',()=>w.style.borderTop='');
w.addEventListener('drop',e=>{e.preventDefault();w.style.borderTop='';const src=$$('.block').find(b=>b._drag);if(src&&src!==w){w.parentNode.insertBefore(src,w);save();renum()}});
return w}

function blkKey(e,el){
if(e.key==='Enter'&&!e.shiftKey&&el.dataset.type!=='code'){e.preventDefault();const t=['bullet','num','todo'].includes(el.dataset.type)?el.dataset.type:'p';const ne=mkBlock({id:uid(),type:t,content:''});el.after(ne);save();renum();ne.querySelector('[contenteditable]')?.focus();return}
if(e.key==='Backspace'){const ce=el.querySelector('[contenteditable]');if(ce?.textContent===''){const bl=$$('#blockList .block');if(bl.length<=1)return;e.preventDefault();const i=[...bl].indexOf(el);const prev=bl[i-1]||bl[i+1];el.remove();save();renum();focEnd(prev?.querySelector('[contenteditable]'));return}}
if(e.key==='Tab'){e.preventDefault();document.execCommand('insertText',false,'  ')}
if(e.key==='/')setTimeout(()=>slashOpen(el),10)}
function renum(){let n=0;$$('#blockList .block').forEach(b=>{if(b.dataset.type==='num'){n++;const c=b.querySelector('.ce-num');if(c)c.dataset.n=n}else n=0})}
function focEnd(el){if(!el)return;el.focus();const r=document.createRange();r.selectNodeContents(el);r.collapse(false);const s=getSelection();s.removeAllRanges();s.addRange(r)}

/* ‚ïê‚ïê‚ïê SLIDES ‚ïê‚ïê‚ïê */
const LAYOUTS=[{id:'center',svg:'<rect x="5" y="6" width="10" height="3" rx="1"/><rect x="6" y="11" width="8" height="2" rx="1"/>'},{id:'left',svg:'<rect x="2" y="5" width="9" height="3" rx="1"/><rect x="2" y="10" width="7" height="2" rx="1"/>'},{id:'split',svg:'<rect x="1" y="3" width="8" height="14" rx="1"/><rect x="11" y="3" width="8" height="14" rx="1" opacity=".3"/>'},{id:'content',svg:'<rect x="2" y="3" width="8" height="2" rx="1"/><rect x="2" y="7" width="16" height="1" rx=".5"/><rect x="2" y="10" width="16" height="1" rx=".5"/>'}];
const BGS=[{id:'dark',c:'#111113'},{id:'navy',c:'#162544'},{id:'purple',c:'#2d1f4e'},{id:'accent',c:'#4f8ff7'},{id:'light',c:'#f0f0f5'}];

function renderSlidesView(p){
const v=$('#viewSlides');v.innerHTML='<div class="slides-area" id="slidesArea"></div>';
const area=$('#slidesArea');(p.slides||[]).forEach((sl,i)=>area.appendChild(mkSlide(sl,i,p)));
const btn=document.createElement('button');btn.className='sb-add-btn';btn.style.maxWidth='960px';btn.innerHTML='+ –î–æ–±–∞–≤–∏—Ç—å —Å–ª–∞–π–¥';btn.onclick=()=>{p.slides.push(defaultSlide());save();renderSlidesView(p)};area.appendChild(btn)}

function readSlides(p){$$('#slidesArea .slide-card').forEach(card=>{const sl=p.slides?.find(s=>s.id===card.dataset.id);if(!sl)return;const body=card.querySelector('.slide-body');if(!body)return;sl.title=body.querySelector('.sl-t')?.innerHTML||'';sl.subtitle=body.querySelector('.sl-s')?.innerHTML||'';sl.body=body.querySelector('.sl-b')?.innerHTML||'';sl.kpis=[...body.querySelectorAll('.sl-kpi')].map(k=>({val:k.querySelector('.sl-kpi-v')?.innerHTML||'',label:k.querySelector('.sl-kpi-l')?.innerHTML||''}));const img=body.querySelector('.sl-img-zone img');if(img)sl.imgSrc=img.src})}

function mkSlide(sl,idx,p){
const card=document.createElement('div');card.className='slide-card';card.dataset.id=sl.id;
const tb=document.createElement('div');tb.className='slide-toolbar';
tb.innerHTML=`<span class="st-num">${idx+1}</span><div class="layout-btns">${LAYOUTS.map(l=>`<button class="l-btn ${sl.layout===l.id?'active':''}" data-l="${l.id}"><svg viewBox="0 0 20 20">${l.svg}</svg></button>`).join('')}</div><div class="st-sep"></div><div class="bg-dots">${BGS.map(b=>`<div class="bg-dot ${sl.bg===b.id?'active':''}" data-bg="${b.id}" style="background:${b.c}"></div>`).join('')}</div><div style="flex:1"></div><button class="st-btn" data-a="kpi"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> KPI</button><button class="st-btn" data-a="dup">‚ßâ</button><button class="st-btn" data-a="del" style="color:var(--red)">‚úï</button>`;
card.appendChild(tb);
tb.querySelectorAll('.l-btn').forEach(b=>b.onclick=()=>{sl.layout=b.dataset.l;save();renderSlidesView(p)});
tb.querySelectorAll('.bg-dot').forEach(d=>d.onclick=()=>{sl.bg=d.dataset.bg;save();renderSlidesView(p)});
tb.querySelector('[data-a=kpi]').onclick=()=>{if(!sl.kpis)sl.kpis=[];sl.kpis.push({val:'',label:''});save();renderSlidesView(p)};
tb.querySelector('[data-a=dup]').onclick=()=>{const dup=JSON.parse(JSON.stringify(sl));dup.id=uid();p.slides.splice(p.slides.indexOf(sl)+1,0,dup);save();renderSlidesView(p)};
tb.querySelector('[data-a=del]').onclick=()=>{if(p.slides.length<=1)return;p.slides=p.slides.filter(s=>s.id!==sl.id);save();renderSlidesView(p)};

const body=document.createElement('div');body.className=`slide-body ly-${sl.layout}`;body.dataset.bg=sl.bg;
if(sl.layout==='split'){
body.innerHTML=`<div class="sl-left-col"><div class="sl-t" contenteditable="true">${sl.title||''}</div><div class="sl-s" contenteditable="true">${sl.subtitle||''}</div><div class="sl-b" contenteditable="true">${sl.body||''}</div></div><div class="sl-right-col"><div class="sl-img-zone">${sl.imgSrc?`<img src="${sl.imgSrc}">`:'<div class="ce-img-ph"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>–§–æ—Ç–æ</div>'}<input type="file" accept="image/*" style="display:none"></div></div>`;
setTimeout(()=>{const z=body.querySelector('.sl-img-zone'),inp=body.querySelector('input[type=file]');z?.addEventListener('click',()=>inp.click());inp?.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{sl.imgSrc=ev.target.result;z.innerHTML=`<img src="${ev.target.result}">`;save()};r.readAsDataURL(f)})},0);
}else{
const kh=(sl.kpis||[]).map(k=>`<div class="sl-kpi"><div class="sl-kpi-v" contenteditable="true">${k.val||''}</div><div class="sl-kpi-l" contenteditable="true">${k.label||''}</div></div>`).join('');
body.innerHTML=`<div class="sl-t" contenteditable="true">${sl.title||''}</div><div class="sl-s" contenteditable="true">${sl.subtitle||''}</div><div class="sl-b" contenteditable="true">${sl.body||''}</div>${kh?`<div class="sl-kpi-row">${kh}</div>`:''}`}
body.querySelectorAll('[contenteditable]').forEach(ce=>ce.addEventListener('input',()=>save()));
card.appendChild(body);return card}

/* ‚ïê‚ïê‚ïê PRESENT ‚ïê‚ïê‚ïê */
let pIdx=0;
function openPres(){save();const p=proj();if(!p||p.type!=='slides')return;pIdx=0;showPres(p);$('#presOv').classList.add('vis');document.addEventListener('keydown',presK)}
function closePres(){$('#presOv').classList.remove('vis');document.removeEventListener('keydown',presK)}
function showPres(p){if(!p)p=proj();const sl=p.slides[pIdx];if(!sl)return;const c=$('#presSlide');const body=document.createElement('div');body.className=`slide-body ly-${sl.layout}`;body.dataset.bg=sl.bg;body.style.flex='1';if(sl.layout==='split'){body.innerHTML=`<div class="sl-left-col"><div class="sl-t">${sl.title||''}</div><div class="sl-s">${sl.subtitle||''}</div><div class="sl-b">${sl.body||''}</div></div><div class="sl-right-col">${sl.imgSrc?`<div class="sl-img-zone" style="border:none"><img src="${sl.imgSrc}"></div>`:''}</div>`}else{const kh=(sl.kpis||[]).map(k=>`<div class="sl-kpi"><div class="sl-kpi-v">${k.val}</div><div class="sl-kpi-l">${k.label}</div></div>`).join('');body.innerHTML=`<div class="sl-t">${sl.title||''}</div><div class="sl-s">${sl.subtitle||''}</div><div class="sl-b">${sl.body||''}</div>${kh?`<div class="sl-kpi-row">${kh}</div>`:''}`}c.innerHTML='';c.appendChild(body);$('#presNum').textContent=`${pIdx+1}/${p.slides.length}`}
function presK(e){if(e.key==='Escape')closePres();if(e.key==='ArrowRight'||e.key===' '){const p=proj();pIdx=Math.min(pIdx+1,p.slides.length-1);showPres(p)}if(e.key==='ArrowLeft'){pIdx=Math.max(pIdx-1,0);showPres()}}
$('#hPresent').onclick=openPres;$('#presNext').onclick=()=>{const p=proj();pIdx=Math.min(pIdx+1,p.slides.length-1);showPres(p)};$('#presPrev').onclick=()=>{pIdx=Math.max(pIdx-1,0);showPres()};$('#presClose').onclick=closePres;

/* ‚ïê‚ïê‚ïê SHEETS ‚ïê‚ïê‚ïê */
function renderSheetsView(p){
const v=$('#viewSheets');const tabs=(p.sheets||[]).map((sh,i)=>`<div class="sheet-tab ${i===0?'active':''}" data-sid="${sh.id}"><span>${esc(sh.name)}</span><button class="st-del">‚úï</button></div>`).join('');
v.innerHTML=`<div class="sheets-area"><div class="sheet-header"><h2>${esc(p.name)}</h2></div><div class="sheet-tabs" id="sheetTabs">${tabs}<button class="add-sheet-tab" id="addSheetTab">+</button></div><div style="margin-bottom:12px;display:flex;gap:8px"><input class="sheet-url-input" id="sheetUrl" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Google –¢–∞–±–ª–∏—Ü—É..."><button class="h-btn primary" id="sheetConnect">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button></div><div class="sheet-frame" id="sheetFrame"><div class="sheet-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/></svg>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Google –¢–∞–±–ª–∏—Ü—É</div></div></div>`;
let active=p.sheets?.[0];if(active?.url){$('#sheetUrl').value=active.url;loadSheet(active.url)}
v.querySelectorAll('.sheet-tab').forEach(tab=>{tab.onclick=()=>{v.querySelectorAll('.sheet-tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');active=p.sheets.find(s=>s.id===tab.dataset.sid);$('#sheetUrl').value=active?.url||'';if(active?.url)loadSheet(active.url);else $('#sheetFrame').innerHTML='<div class="sheet-empty">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É</div>'};tab.querySelector('.st-del').onclick=e=>{e.stopPropagation();if(p.sheets.length<=1)return;p.sheets=p.sheets.filter(s=>s.id!==tab.dataset.sid);save();renderSheetsView(p)}});
$('#addSheetTab').onclick=()=>{p.sheets.push({id:uid(),name:'–õ–∏—Å—Ç '+(p.sheets.length+1),url:''});save();renderSheetsView(p)};
$('#sheetConnect').onclick=()=>{const url=$('#sheetUrl').value.trim();if(!url||!active)return;active.url=url;save();loadSheet(url)}}
function readSheets(){}
function loadSheet(url){let eu=url;const m=url.match(/\/d\/([a-zA-Z0-9-_]+)/);if(m)eu=`https://docs.google.com/spreadsheets/d/${m[1]}/htmlview?widget=true&headers=false`;$('#sheetFrame').innerHTML=`<iframe src="${eu}" style="width:100%;height:100%;min-height:500px;border:none"></iframe>`}

/* ‚ïê‚ïê‚ïê KANBAN ‚ïê‚ïê‚ïê */
const KCOLS=['#54566b','#4f8ff7','#34d399','#fbbf24','#f87171','#a78bfa','#f472b6','#fb923c'];

function renderKanban(p){
const v=$('#viewKanban');v.innerHTML=`<div class="kanban-area"><div class="kanban-header"><h2>${esc(p.name)}</h2></div><div class="kanban-board" id="kBoard"></div></div>`;
const board=$('#kBoard');(p.columns||[]).forEach(col=>board.appendChild(mkCol(col,p)));
const addBtn=document.createElement('button');addBtn.className='add-col-btn';addBtn.innerHTML='+ –ö–æ–ª–æ–Ω–∫–∞';
addBtn.onclick=()=>{const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏:');if(!name)return;p.columns.push({id:uid(),title:name,color:KCOLS[p.columns.length%KCOLS.length],cards:[]});save();renderKanban(p)};
board.appendChild(addBtn)}

function mkCol(col,p){
const el=document.createElement('div');el.className='kanban-col';el.dataset.cid=col.id;
const head=document.createElement('div');head.className='kanban-col-head';
head.innerHTML=`<div class="kc-dot" style="background:${col.color}"></div><div class="kc-title" contenteditable="true">${esc(col.title)}</div><span class="kc-count">${col.cards?.length||0}</span><button class="kc-del"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>`;
head.querySelector('.kc-title').addEventListener('input',e=>{col.title=e.target.textContent;save()});
head.querySelector('.kc-del').addEventListener('click',()=>{if(col.cards?.length&&!confirm(`${col.cards.length} –∑–∞–¥–∞—á –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã`))return;p.columns=p.columns.filter(c=>c.id!==col.id);save();renderKanban(p)});
el.appendChild(head);

const cards=document.createElement('div');cards.className='kanban-cards';
(col.cards||[]).forEach(c=>cards.appendChild(mkCard(c,col,p)));
el.appendChild(cards);

// drop zone
cards.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='move';cards.classList.add('drag-hover')});
cards.addEventListener('dragleave',e=>{if(!cards.contains(e.relatedTarget))cards.classList.remove('drag-hover')});
cards.addEventListener('drop',e=>{e.preventDefault();cards.classList.remove('drag-hover');if(!dragCard||!dragFromCol)return;dragFromCol.cards=dragFromCol.cards.filter(c=>c.id!==dragCard.id);col.cards.push(dragCard);dragCard=null;dragFromCol=null;save();renderKanban(p)});

// new card form
const form=document.createElement('div');form.className='knf';
form.innerHTML=`<input class="knf-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..." data-f="title"><textarea class="knf-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." rows="2" data-f="desc"></textarea><div class="knf-row"><select class="knf-sel" data-f="pri"><option value="">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option><option value="high">–í—ã—Å–æ–∫–∏–π</option><option value="mid">–°—Ä–µ–¥–Ω–∏–π</option><option value="low">–ù–∏–∑–∫–∏–π</option></select><input class="knf-date" type="date" data-f="date"></div><div class="knf-actions"><button class="knf-btn ok" data-a="add">–î–æ–±–∞–≤–∏—Ç—å</button><button class="knf-btn cancel" data-a="cancel">–û—Ç–º–µ–Ω–∞</button></div>`;
form.querySelector('[data-a=add]').onclick=()=>{const t=form.querySelector('[data-f=title]').value.trim();if(!t)return;col.cards.push({id:uid(),text:t,desc:form.querySelector('[data-f=desc]').value.trim(),priority:form.querySelector('[data-f=pri]').value,date:form.querySelector('[data-f=date]').value,color:col.color});save();renderKanban(p)};
form.querySelector('[data-a=cancel]').onclick=()=>form.classList.remove('open');
form.querySelector('[data-f=title]').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();form.querySelector('[data-a=add]').click()}if(e.key==='Escape')form.classList.remove('open')});
el.appendChild(form);

const addBtn=document.createElement('button');addBtn.className='kanban-add';
addBtn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É';
addBtn.onclick=()=>{$$('.knf').forEach(f=>f.classList.remove('open'));form.classList.add('open');form.querySelector('[data-f=title]').value='';form.querySelector('[data-f=desc]').value='';form.querySelector('[data-f=pri]').value='';form.querySelector('[data-f=date]').value='';form.querySelector('[data-f=title]').focus()};
el.appendChild(addBtn);return el}

function mkCard(c,col,p){
const el=document.createElement('div');el.className='kanban-card';el.dataset.kid=c.id;el.draggable=true;
let prioH='';if(c.priority==='high')prioH='<span class="kk-priority p-high">–í—ã—Å–æ–∫–∏–π</span>';else if(c.priority==='mid')prioH='<span class="kk-priority p-mid">–°—Ä–µ–¥–Ω–∏–π</span>';else if(c.priority==='low')prioH='<span class="kk-priority p-low">–ù–∏–∑–∫–∏–π</span>';
let dateH='';if(c.date){const d=new Date(c.date);const now=new Date();now.setHours(0,0,0,0);const over=d<now;dateH=`<span class="kk-date${over?' overdue':''}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>${d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'})}</span>`}
el.innerHTML=`<button class="kk-edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><span class="kk-title-text">${esc(c.text)}</span>${c.desc?`<div class="kk-desc">${esc(c.desc)}</div>`:''}${prioH||dateH?`<div class="kk-meta">${prioH}${dateH}</div>`:''}`;

el.querySelector('.kk-edit').addEventListener('click',e=>{e.stopPropagation();openTaskModal(c,col,p)});
el.addEventListener('dragstart',e=>{dragCard=c;dragFromCol=col;el.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',c.id)});
el.addEventListener('dragend',()=>{el.classList.remove('dragging');dragCard=null;dragFromCol=null;$$('.kanban-card').forEach(c=>c.classList.remove('drag-over-top','drag-over-bot'));$$('.kanban-cards').forEach(c=>c.classList.remove('drag-hover'))});
el.addEventListener('dragover',e=>{e.preventDefault();if(!dragCard||dragCard.id===c.id)return;$$('.kanban-card').forEach(x=>x.classList.remove('drag-over-top','drag-over-bot'));const r=el.getBoundingClientRect();if(e.clientY<r.top+r.height/2)el.classList.add('drag-over-top');else el.classList.add('drag-over-bot')});
el.addEventListener('dragleave',()=>el.classList.remove('drag-over-top','drag-over-bot'));
el.addEventListener('drop',e=>{e.preventDefault();e.stopPropagation();$$('.kanban-card').forEach(x=>x.classList.remove('drag-over-top','drag-over-bot'));$$('.kanban-cards').forEach(x=>x.classList.remove('drag-hover'));if(!dragCard||dragCard.id===c.id)return;const r=el.getBoundingClientRect();const above=e.clientY<r.top+r.height/2;dragFromCol.cards=dragFromCol.cards.filter(x=>x.id!==dragCard.id);const ti=col.cards.findIndex(x=>x.id===c.id);col.cards.splice(above?ti:ti+1,0,dragCard);dragCard=null;dragFromCol=null;save();renderKanban(p)});

// touch drag
let clone=null;
el.addEventListener('touchstart',e=>{dragCard=c;dragFromCol=col;el._tt=setTimeout(()=>{el.classList.add('dragging');clone=el.cloneNode(true);clone.style.cssText='position:fixed;z-index:9999;pointer-events:none;opacity:.8;width:'+el.offsetWidth+'px;transform:rotate(2deg)';document.body.appendChild(clone)},200)},{passive:true});
el.addEventListener('touchmove',e=>{if(!clone){clearTimeout(el._tt);return}e.preventDefault();const t=e.touches[0];clone.style.left=(t.clientX-60)+'px';clone.style.top=(t.clientY-20)+'px';$$('.kanban-cards').forEach(c=>c.classList.remove('drag-hover'));const target=document.elementFromPoint(t.clientX,t.clientY)?.closest('.kanban-cards');if(target)target.classList.add('drag-hover')},{passive:false});
el.addEventListener('touchend',e=>{clearTimeout(el._tt);if(clone){clone.remove();clone=null;el.classList.remove('dragging');const t=e.changedTouches[0];const targetCol=document.elementFromPoint(t.clientX,t.clientY)?.closest('.kanban-col');if(targetCol&&dragCard){const tc=p.columns.find(co=>co.id===targetCol.dataset.cid);if(tc){dragFromCol.cards=dragFromCol.cards.filter(x=>x.id!==dragCard.id);tc.cards.push(dragCard)}}$$('.kanban-cards').forEach(c=>c.classList.remove('drag-hover'));dragCard=null;dragFromCol=null;save();renderKanban(p)}});
return el}

/* ‚ïê‚ïê‚ïê TASK MODAL ‚ïê‚ïê‚ïê */
function openTaskModal(card,col,p){
editCard=card;editCol=col;
$('#tmTitle').value=card.text||'';$('#tmDesc').value=card.desc||'';$('#tmPriority').value=card.priority||'';$('#tmDate').value=card.date||'';$('#tmColBadge').textContent=col.title;
const sel=$('#tmMove');sel.innerHTML='';p.columns.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.title;if(c.id===col.id)o.selected=true;sel.appendChild(o)});
$('#taskModalBg').classList.add('vis');setTimeout(()=>$('#tmTitle').focus(),100)}
$('#tmClose').onclick=()=>$('#taskModalBg').classList.remove('vis');
$('#taskModalBg').onclick=e=>{if(e.target===$('#taskModalBg'))$('#taskModalBg').classList.remove('vis')};
$('#tmSave').onclick=()=>{if(!editCard)return;editCard.text=$('#tmTitle').value.trim()||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';editCard.desc=$('#tmDesc').value.trim();editCard.priority=$('#tmPriority').value;editCard.date=$('#tmDate').value;const tid=$('#tmMove').value;const p=proj();if(tid!==editCol.id){editCol.cards=editCol.cards.filter(c=>c.id!==editCard.id);const tc=p.columns.find(c=>c.id===tid);if(tc)tc.cards.push(editCard)}save();renderKanban(p);$('#taskModalBg').classList.remove('vis');editCard=null;editCol=null};
$('#tmDel').onclick=()=>{if(!editCard||!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?'))return;editCol.cards=editCol.cards.filter(c=>c.id!==editCard.id);save();renderKanban(proj());$('#taskModalBg').classList.remove('vis');editCard=null;editCol=null};
$('#tmTitle').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();$('#tmSave').click()}});

/* ‚ïê‚ïê‚ïê SLASH MENU ‚ïê‚ïê‚ïê */
let slashRef=null;
function slashOpen(bl){slashRef=bl;const m=$('#slashMenu');const r=bl.getBoundingClientRect();m.style.left=Math.min(r.left,innerWidth-280)+'px';m.style.top=(r.bottom+4+scrollY)+'px';m.classList.add('vis');$('#smInput').value='';$('#smInput').focus();slashRender('')}
function slashClose(){$('#slashMenu').classList.remove('vis');slashRef=null}
function slashRender(q){const c=$('#smItems');c.innerHTML='';const ql=q.toLowerCase();BT.forEach(g=>{const f=g.items.filter(i=>i.n.toLowerCase().includes(ql)||i.t.includes(ql));if(!f.length)return;c.innerHTML+=`<div class="sm-grp">${g.g}</div>`;f.forEach(i=>{const d=document.createElement('div');d.className='sm-it';d.innerHTML=`<div class="sm-it-icon">${i.i}</div><div><div class="sm-it-name">${i.n}</div><div class="sm-it-desc">${i.d}</div></div>`;d.onclick=()=>slashPick(i);c.appendChild(d)})})}
function slashPick(item){if(slashRef){const ce=slashRef.querySelector('[contenteditable]');if(ce){let h=ce.innerHTML;const si=h.lastIndexOf('/');if(si!==-1)ce.innerHTML=h.substring(0,si)+h.substring(si+1)}if(ce?.textContent.trim()===''&&slashRef.dataset.type==='p'){const ne=mkBlock({id:slashRef.dataset.id,type:item.t,content:''});slashRef.replaceWith(ne);save();renum();ne.querySelector('[contenteditable]')?.focus()}else{const ne=mkBlock({id:uid(),type:item.t,content:''});slashRef.after(ne);save();renum();ne.querySelector('[contenteditable]')?.focus()}}slashClose()}
$('#smInput').addEventListener('input',e=>slashRender(e.target.value));
$('#smInput').addEventListener('keydown',e=>{if(e.key==='Escape')slashClose();if(e.key==='Enter'){const f=$('#smItems .sm-it');if(f)f.click()}});
document.addEventListener('mousedown',e=>{if(!e.target.closest('.slash-menu')&&!e.target.closest('.blk-plus'))slashClose()});


/* ‚ïê‚ïê‚ïê INLINE TB ‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê INLINE TB ‚ïê‚ïê‚ïê */
let inlineTbTimer=null;
document.addEventListener('selectionchange',()=>{
  clearTimeout(inlineTbTimer);
  inlineTbTimer=setTimeout(()=>{
    const sel=getSelection();
    if(!sel.rangeCount||sel.isCollapsed){$('#inlineTb').classList.remove('vis');return}
    const rng=sel.getRangeAt(0);
    const txt=sel.toString().trim();
    if(!txt){$('#inlineTb').classList.remove('vis');return}
    const anc=rng.commonAncestorContainer;
    const node=anc.nodeType===3?anc.parentElement:anc;
    if(!node||!node.closest||!node.closest('[contenteditable]')){$('#inlineTb').classList.remove('vis');return}
    const r=rng.getBoundingClientRect();
    if(r.width===0){$('#inlineTb').classList.remove('vis');return}
    const tb=$('#inlineTb');
    tb.style.left=Math.max(4,r.left+r.width/2-80)+'px';
    tb.style.top=(r.top-40+scrollY)+'px';
    tb.classList.add('vis');
  },150);
});


/* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
let modalType='notes';
function openModal(){modalType='notes';$$('#modalTypes .modal-type').forEach(t=>t.classList.toggle('selected',t.dataset.type==='notes'));$('#modalInput').value='';$('#modalBg').classList.add('vis');setTimeout(()=>$('#modalInput').focus(),100)}
$('#newProjectBtn').onclick=openModal;
$('#modalCancel').onclick=()=>$('#modalBg').classList.remove('vis');
$('#modalBg').onclick=e=>{if(e.target===$('#modalBg'))$('#modalBg').classList.remove('vis')};

$$('#modalTypes .modal-type').forEach(t=>t.onclick=()=>{modalType=t.dataset.type;$$('#modalTypes .modal-type').forEach(x=>x.classList.remove('selected'));t.classList.add('selected')});
$('#modalOk').onclick=()=>{createProject(modalType,$('#modalInput').value||'');$('#modalBg').classList.remove('vis')};
$('#modalInput').addEventListener('keydown',e=>{if(e.key==='Enter')$('#modalOk').click()});

/* ‚ïê‚ïê‚ïê GLOBAL ‚ïê‚ïê‚ïê */
$('#hToggle').onclick=()=>{const sb=$('#sidebar');if(innerWidth<=768)sb.classList.toggle('open-m');else{sb.classList.toggle('closed');$('#mainWrap').classList.toggle('full',sb.classList.contains('closed'))}};
$('#navHome').onclick=showHome;
$('#hExport').onclick=()=>print();
document.addEventListener('keydown',e=>{if(e.key==='Escape'){slashClose();$('#inlineTb').classList.remove('vis');$('#modalBg').classList.remove('vis');$('#taskModalBg').classList.remove('vis');$$('.knf').forEach(f=>f.classList.remove('open'))}if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();save()}});
setInterval(save,3000);

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
load();renderSidebar();if(S.current)openProject(S.current);else showHome();
</script>
</body>
</html>


